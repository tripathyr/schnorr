import { deepStrictEqual, throws } from 'assert';
import { should } from 'micro-should';
import { hex } from '@scure/base';
import * as btc from '../index.js';

const BIP67 = [
  {
    input: [
      '02ff12471208c14bd580709cb2358d98975247d8765f92bc25eab3b2763ed605f8',
      '02fe6f0a5a297eb38c391581c4413e084773ea23954d93f7753db7dc0adc188b2f',
    ],
    sorted: [
      '02fe6f0a5a297eb38c391581c4413e084773ea23954d93f7753db7dc0adc188b2f',
      '02ff12471208c14bd580709cb2358d98975247d8765f92bc25eab3b2763ed605f8',
    ],
    script:
      '522102fe6f0a5a297eb38c391581c4413e084773ea23954d93f7753db7dc0adc188b2f2102ff12471208c14bd580709cb2358d98975247d8765f92bc25eab3b2763ed605f852ae',
    address: '39bgKC7RFbpoCRbtD5KEdkYKtNyhpsNa3Z',
  },
  {
    input: [
      '02632b12f4ac5b1d1b72b2a3b508c19172de44f6f46bcee50ba33f3f9291e47ed0',
      '027735a29bae7780a9755fae7a1c4374c656ac6a69ea9f3697fda61bb99a4f3e77',
      '02e2cc6bd5f45edd43bebe7cb9b675f0ce9ed3efe613b177588290ad188d11b404',
    ],
    sorted: [
      '02632b12f4ac5b1d1b72b2a3b508c19172de44f6f46bcee50ba33f3f9291e47ed0',
      '027735a29bae7780a9755fae7a1c4374c656ac6a69ea9f3697fda61bb99a4f3e77',
      '02e2cc6bd5f45edd43bebe7cb9b675f0ce9ed3efe613b177588290ad188d11b404',
    ],
    script:
      '522102632b12f4ac5b1d1b72b2a3b508c19172de44f6f46bcee50ba33f3f9291e47ed021027735a29bae7780a9755fae7a1c4374c656ac6a69ea9f3697fda61bb99a4f3e772102e2cc6bd5f45edd43bebe7cb9b675f0ce9ed3efe613b177588290ad188d11b40453ae',
    address: '3CKHTjBKxCARLzwABMu9yD85kvtm7WnMfH',
  },
  {
    input: [
      '030000000000000000000000000000000000004141414141414141414141414141',
      '020000000000000000000000000000000000004141414141414141414141414141',
      '020000000000000000000000000000000000004141414141414141414141414140',
      '030000000000000000000000000000000000004141414141414141414141414140',
    ],
    sorted: [
      '020000000000000000000000000000000000004141414141414141414141414140',
      '020000000000000000000000000000000000004141414141414141414141414141',
      '030000000000000000000000000000000000004141414141414141414141414140',
      '030000000000000000000000000000000000004141414141414141414141414141',
    ],
    script:
      '522102000000000000000000000000000000000000414141414141414141414141414021020000000000000000000000000000000000004141414141414141414141414141210300000000000000000000000000000000000041414141414141414141414141402103000000000000000000000000000000000000414141414141414141414141414154ae',
    address: '32V85igBri9zcfBRVupVvwK18NFtS37FuD',
  },
  {
    input: [
      '022df8750480ad5b26950b25c7ba79d3e37d75f640f8e5d9bcd5b150a0f85014da',
      '03e3818b65bcc73a7d64064106a859cc1a5a728c4345ff0b641209fba0d90de6e9',
      '021f2f6e1e50cb6a953935c3601284925decd3fd21bc445712576873fb8c6ebc18',
    ],
    sorted: [
      '021f2f6e1e50cb6a953935c3601284925decd3fd21bc445712576873fb8c6ebc18',
      '022df8750480ad5b26950b25c7ba79d3e37d75f640f8e5d9bcd5b150a0f85014da',
      '03e3818b65bcc73a7d64064106a859cc1a5a728c4345ff0b641209fba0d90de6e9',
    ],
    script:
      '5221021f2f6e1e50cb6a953935c3601284925decd3fd21bc445712576873fb8c6ebc1821022df8750480ad5b26950b25c7ba79d3e37d75f640f8e5d9bcd5b150a0f85014da2103e3818b65bcc73a7d64064106a859cc1a5a728c4345ff0b641209fba0d90de6e953ae',
    address: '3Q4sF6tv9wsdqu2NtARzNCpQgwifm2rAba',
  },
];

for (let i = 0; i < BIP67.length; i++) {
  const t = BIP67[i];
  should(`BIP67(${i})`, () => {
    const input = t.input.map(hex.decode);
    const sorted = btc._sortPubkeys(input);
    deepStrictEqual(sorted, t.sorted.map(hex.decode));
    deepStrictEqual(hex.encode(btc.p2ms(2, sorted).script), t.script);
    const payment = btc.sortedMultisig(2, input);
    deepStrictEqual(payment.address, t.address);
  });
}

// ESM is broken.
import url from 'url';
if (import.meta.url === url.pathToFileURL(process.argv[1]).href) {
  should.run();
}
